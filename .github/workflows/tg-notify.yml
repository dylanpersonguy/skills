name: Telegram + WhatsApp Commit Notify
on:
  push:
    paths-ignore:
      - '.github/workflows/tg-notify.yml'
jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send to Telegram & WhatsApp
        uses: actions/github-script@v7
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          WA_INSTANCE: ${{ secrets.WA_INSTANCE }}
          WA_TOKEN: ${{ secrets.WA_TOKEN }}
          WA_GROUP_ID: ${{ secrets.WA_GROUP_ID }}
        with:
          script: |
            const commitMsg = context.payload.head_commit?.message || 'No message';
            const firstLine = commitMsg.split('\n')[0];
            const repo = context.payload.repository?.full_name || 'unknown';
            const branch = (context.ref || '').replace('refs/heads/', '');
            const sha = (context.sha || '').substring(0, 7);

            // Translate commit message to Spanish
            let spanishMsg = firstLine;
            try {
              const res = await fetch('https://lingva.ml/api/v1/en/es/' + encodeURIComponent(firstLine));
              const data = await res.json();
              if (data.translation) spanishMsg = data.translation;
            } catch (e) {
              try {
                const res2 = await fetch('https://api.mymemory.translated.net/get?q=' + encodeURIComponent(firstLine) + '&langpair=en|es');
                const data2 = await res2.json();
                if (data2.responseData?.translatedText) spanishMsg = data2.responseData.translatedText;
              } catch (e2) {
                // If translation fails, use original
              }
            }

            const englishText = [
              `\u{1F680} *New Update* \u2014 \`${repo}\``,
              ``,
              `\u{1F1FA}\u{1F1F8} Our developers just finished implementing new changes:`,
              ``,
              `\u{1F4DD} \`${firstLine}\``,
              ``,
              `\u{1F1EA}\u{1F1F8} Nuestros desarrolladores acaban de implementar nuevos cambios:`,
              ``,
              `\u{1F4DD} \`${spanishMsg}\``,
              ``,
              `\u{1F33F} Branch: \`${branch}\` \u2022 \`${sha}\``,
            ].join('\n');

            const whatsappText = [
              `ðŸš€ *New Update* â€” ${repo}`,
              ``,
              `ðŸ‡ºðŸ‡¸ Our developers just finished implementing new changes:`,
              ``,
              `ðŸ“ ${firstLine}`,
              ``,
              `ðŸ‡ªðŸ‡¸ Nuestros desarrolladores acaban de implementar nuevos cambios:`,
              ``,
              `ðŸ“ ${spanishMsg}`,
              ``,
              `ðŸŒ¿ Branch: ${branch} â€¢ ${sha}`,
            ].join('\n');

            // Send to Telegram
            await fetch(`https://api.telegram.org/bot${process.env.TG_BOT_TOKEN}/sendMessage`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                chat_id: process.env.TG_CHAT_ID,
                text: englishText,
                parse_mode: 'Markdown',
              }),
            });

            // Send to WhatsApp via Green API
            await fetch(`https://api.green-api.com/waInstance${process.env.WA_INSTANCE}/sendMessage/${process.env.WA_TOKEN}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                chatId: process.env.WA_GROUP_ID,
                message: whatsappText,
              }),
            });